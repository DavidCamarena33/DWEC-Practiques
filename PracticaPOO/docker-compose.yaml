services:
  # --- Servicio 1: Base de Datos (MySQL) ---
  db:
    image: mysql/mysql-server:latest
    container_name: mysql_db
    restart: always
    environment:
      # Esto lee las variables MYSQL_... de tu fichero .env
      # y las usa para configurar el contenedor de MySQL.
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./base datos/BASE.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mi-red-app
    command: --log_bin_trust_function_creators=1

  # --- Servicio 2: Backend (Node.js) ---
  backend:
    container_name: node_backend
    restart: always
    build:
      context: ./programacio
      dockerfile: Dockerfile
    ports:
      - "${NODE_PORT}:${NODE_PORT}"
    command: npm run test
      
    environment: 
      # --- ¡AQUÍ ESTÁ LA CORRECCIÓN! ---
      # Le decimos al backend que el host de la BD se llama 'db',
      # que es el nombre de tu servicio de MySQL en esta red.
      DB_HOST: db

      # Esto "traduce" las variables para tu app Node.js
      # (conectar.js busca DB_USER, no MYSQL_USER)
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      DB_NAME: ${MYSQL_DATABASE}
    depends_on:
      - db
    networks:
      - mi-red-app
    volumes:
      # 1. Monta tu código para que nodemon vea los cambios
      - ./programacio:/usr/src/app

      # 2. Protege la carpeta node_modules de ser sobrescrita
      # (Esta es una MUY BUENA práctica que ya tenías)
      - node_modules_data:/usr/src/app/node_modules

# Definición de la red
networks:
  mi-red-app:
    driver: bridge

# Definición de TODOS los volúmenes
volumes:
  # El de la base de datos
  mysql-data:
    driver: local
  
  # El de los módulos de Node
  node_modules_data:
    driver: local